{"version":3,"sources":["assets/Script/UIScript/UILight.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import UILight_Auto from \"../AutoScripts/UILight_Auto\";\nimport TexturePlus from \"../Common/Components/TexturePlus\";\nimport Light from \"../Common/Light/Light\";\nimport LightUtils from \"../Common/Light/LightUtils\";\nimport Obstacle from \"../Common/Light/Obstacle\";\nimport FormMgr from \"../UIFrame/FormMgr\";\nimport { UIScreen } from \"../UIFrame/UIForm\";\n\nconst {ccclass, property} = cc._decorator;\n\n@ccclass\nexport default class UILight extends UIScreen {\n    \n    @property(Obstacle)\n    private obstacle: Obstacle = null;\n    @property(Light)\n    private light: Light = null;\n\n    @property(cc.Camera)\n    camera: cc.Camera = null;\n    @property(cc.Sprite) spShadow: cc.Sprite = null;\n\n    private _shadowTexture: cc.RenderTexture = new cc.RenderTexture();\n    view: UILight_Auto;\n    onLoad () {\n        cc.director.on(cc.Director.EVENT_BEFORE_DRAW, () => {\n            this._shadowTexture = new cc.RenderTexture();\n            this._shadowTexture.initWithSize(cc.visibleRect.width, cc.visibleRect.height, cc.game._renderContext.STENCIL_INDEX8);\n            this.camera.targetTexture = this._shadowTexture;\n        }, this);\n\n        cc.director.on(cc.Director.EVENT_AFTER_DRAW, () => {\n            this.spShadow.spriteFrame.setTexture(this._shadowTexture);\n            this.spShadow.spriteFrame.setFlipY(true);\n            this.spShadow.markForRender(true)\n        }, this);\n    }\n\n    start () {\n        let viewSize = cc.view.getVisibleSize();\n        this.obstacle.addPolygon('', [\n            cc.v2(0, 0), cc.v2(viewSize.width, 0), cc.v2(viewSize.width, viewSize.height), cc.v2(0, viewSize.height)\n        ]);\n\n        let ndObstacle = this.obstacle.node;\n        for(let i=0; i<ndObstacle.childrenCount; i++) {\n            let node = ndObstacle.children[i];\n            let com = node.getComponent(TexturePlus);\n            if(!com) continue;\n            \n            let points = com.polygon.concat([]);\n            points = points.map(e => e.add(node.getPosition()));\n\n            this.obstacle.addPolygon(com.node.uuid, points);\n        }\n\n        this.view.Back.addClick(() => {\n            FormMgr.backScene();\n        }, this);\n    }\n\n\n    private draw() {\n        let polygons = this.obstacle.getPolygons(this.light.getBound());\n        \n        let intersections = LightUtils.getIntersections(this.light.node.getPosition(), polygons);\n        this.light.draw(intersections);\n    }\n\n    update (dt: number) {\n        this.draw();       \n    }\n}\n"]}