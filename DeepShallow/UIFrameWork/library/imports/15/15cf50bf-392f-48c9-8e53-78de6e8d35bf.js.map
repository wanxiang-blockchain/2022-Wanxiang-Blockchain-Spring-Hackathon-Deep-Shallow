{"version":3,"sources":["assets/Script/UIFrame/EventCenter.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { Pool, IPool } from \"../Common/Utils/Pool\";\n\nexport class EventInfo implements IPool {\n    callback: Function;\n    target: any;\n    once: boolean;\n\n    free() {\n        this.callback = null;\n        this.target = null;\n        this.once = false;\n    }\n\n    init(callback: Function, target: Object, once: boolean) {\n        this.callback = callback;\n        this.target = target;\n        this.once = once;\n    }\n}\n\nclass RemoveCommand {\n    public eventName:string;\n    public targetId:string;\n    public callback: Function;\n\n    constructor(eventName: string, callback: Function, targetId: string) {\n        this.eventName = eventName;\n        this.callback = callback;\n        this.targetId = targetId;\n    }\n}\n\nlet idSeed = 1;         // 这里有一个小缺陷就是idSeed有最大值,Number.MAX_VALUE\nexport class EventCenter {\n\n    private static _listeners: {[eventName: string]: {[id: string]: Array<EventInfo>}} = cc.js.createMap();\n    private static _dispatching : number = 0;\n    private static _removeCommands : RemoveCommand[] = [];\n\n    private static _eventPool: Pool<EventInfo> = new Pool<EventInfo>(() => {\n        return new EventInfo();\n    }, 10);\n\n    public static on(eventName: string, callback: Function, target: any = undefined, once = false) {\n        target = target || this;\n        let targetId: string = target['uuid'] || target['id'];\n        if(targetId === undefined) {\n            target['uuid'] = targetId = '' + idSeed++;\n        }\n        this.onById(eventName, targetId, target, callback, once);\n    }\n    public static once(eventName: string, callback: Function, target: any = undefined) {\n        this.on(eventName, callback, target, true);\n    }\n    private static onById(eventName: string, targetId: string, target: any, cb: Function, once: boolean) {\n        let collection = this._listeners[eventName];\n        if(!collection) {\n            collection = this._listeners[eventName] = {};\n        }\n        let events = collection[targetId];\n        if(!events) {\n            events = collection[targetId] = [];\n        }\n        let eventInfo = this._eventPool.alloc();\n        eventInfo.init(cb, target, once);\n        events.push(eventInfo);\n    }\n\n    public static off(eventName: string, callback: Function, target: any = undefined) {\n        target = target || this;\n        let targetId = target['uuid'] || target['id'];\n        if(!targetId) return ;\n        this.offById(eventName, callback, targetId);\n    }\n    public static targetOff(target: any) {\n        target = target || this;\n        let targetId = target['uuid'] || target['id'];\n        if(!targetId) return ;\n        for(let event in this._listeners) {\n            let collection = this._listeners[event];\n            if(collection[targetId] !== undefined) {\n                delete collection[targetId];\n            }\n        }\n    }\n    private static offById(eventName: string, callback: Function, targetId: string) {\n        if(this._dispatching > 0) {\n            let cmd = new RemoveCommand(eventName, callback, targetId);\n            this._removeCommands.push(cmd);\n        }else {\n            this.doOff(eventName, callback, targetId);\n        }\n    }\n    private static doOff(eventName: string, callback: Function, targetId: string) {\n        let collection = this._listeners[eventName];\n        if(!collection) return ;\n        let events = collection[targetId];\n        if(!events) return ;\n        for(let i=events.length-1; i>=0; i--) {\n            if(events[i].callback === callback) {\n                events.splice(i, 1);\n            }\n        }\n        if(events.length === 0) {\n            collection[targetId] = null;\n            delete collection[targetId];\n        }\n    }\n\n    private static doRemoveCommands() {\n        if(this._dispatching !== 0) {\n            return;\n        }\n        for(let cmd of this._removeCommands) {\n            this.doOff(cmd.eventName, cmd.callback, cmd.targetId);\n        }\n        this._removeCommands.length = 0;\n    }\n    \n    public static emit(eventName: string, ...param: any[]) {\n        let collection = this._listeners[eventName];\n        if(!collection) return false;\n        this._dispatching ++;\n        for(let targetId in collection) {\n            for(let eventInfo of collection[targetId]) {\n                eventInfo.callback.call(eventInfo.target, ...param);\n                if(eventInfo.once) {\n                    let cmd = new RemoveCommand(eventName, eventInfo.callback, targetId);\n                    this._removeCommands.push(cmd);\n                }\n            }\n        }\n        this._dispatching --;\n        this.doRemoveCommands();\n    }\n}\n\n\n// EventCenter.on(\"Event1\", eventCb);\n\n// function eventCb(param) {\n//     console.log(param);\n// }\n\n// EventCenter.once('EventOnce', eventOnceCb);\n\n// function eventOnceCb(param) {\n//     console.log(param);\n// }\n\n// EventCenter.emit('Event1', '123');\n// EventCenter.emit('EventOnce', '121233');\n\n// EventCenter.off('Event1', eventCb);\n\n// EventCenter.emit('Event1', '123');\n// EventCenter.emit('EventOnce', '123');"]}